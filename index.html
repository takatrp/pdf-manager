<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>å®‰å¿ƒpdfãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï½œæ¾æœ¬ä¼šè¨ˆäº‹å‹™æ‰€</title>

<meta name="theme-color" content="#578899" />
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

<style>
  :root {
    --bg:#f4f9fb; --card:#fff; --ink:#1e2a2d; --muted:#5a6a6d;
    --accent:#578899; --accent-2:#7aa2b0; --shadow:0 10px 30px rgba(35,80,90,.12);
    --warn: #e74c3c; --success: #27ae60;
    --mk-brand:#578899; --mk-line:#e2e8f0; --mk-ink:#0f172a; --mk-muted:#64748b;
  }
  html,body{height:100%}
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN","Yu Gothic","Noto Sans JP",Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg);
    color:var(--ink);
    padding-bottom: calc(62px + env(safe-area-inset-bottom));
  }
  .wrap{
    padding:max(12px,env(safe-area-inset-top)) max(14px,env(safe-area-inset-right)) calc(16px + env(safe-area-inset-bottom)) max(14px,env(safe-area-inset-left));
    max-width:560px;
    margin:0 auto;
  }

  /* header */
  header{padding:8px 6px 2px}
  .brand{display:flex;align-items:center;gap:10px}
  .logo-link{display:inline-flex;line-height:0;text-decoration:none}
  .logo{height:48px;width:auto;object-fit:contain}
  .title{
    flex:1;min-width:0;white-space:nowrap;margin:0;
    font-weight:800;letter-spacing:.02em;line-height:1.2;
    font-size:clamp(16px,4.6vw,22px);color:#0e2430;
  }
  .subtitle{color:#5a6a6d;font-size:12px;margin:6px 0 0; line-height: 1.5;}

  /* card & fields */
  .card{
    background:#fff;border-radius:16px;
    box-shadow:0 10px 30px rgba(35,80,90,.12);
    padding:20px 16px;margin:16px 0;
  }
  .field{margin:0 0 20px}
  .field:last-child { margin-bottom: 0; }
  .label.big{font-size:16px;font-weight:800;color:#324245; margin-bottom: 8px;}
  .helper{font-size:12px;color:#6a7a7d;margin:4px 0 8px; line-height: 1.4;}

  /* Inputs (ãƒˆãƒ³ãƒãƒŠã«åˆã‚ã›ãŸãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›æ ) */
  .file-box {
    background:#f8fcfd; border: 2px dashed #7aa2b0;
    border-radius:12px; padding:12px;
    transition: background-color .28s ease, border-color .28s ease;
  }
  .file-box:hover { background: #eef7f8; border-color: #578899; }
  .file-box input[type="file"] {
    width: 100%; font-size: 14px; color: var(--ink); cursor: pointer;
  }
  .file-box.dragover {
    background:#e9f4f7;
    border-color:#3e6f80;
  }
  .drop-hint {
    font-size:12px;
    color:#4f6570;
    margin-top:8px;
  }
  .merge-list {
    margin-top:12px;
    display:grid;
    gap:10px;
  }
  .merge-item {
    display:flex;
    align-items:center;
    gap:12px;
    padding:10px;
    border:1px solid #d9eaed;
    border-radius:12px;
    background:#fff;
    cursor:grab;
  }
  .merge-item:active { cursor:grabbing; }
  .merge-item.dragging {
    opacity:.45;
    border-style:dashed;
  }
  .thumb-wrap {
    width:88px;
    height:120px;
    border-radius:8px;
    border:1px solid #ccdce0;
    overflow:hidden;
    background:#f3f8fa;
    flex:0 0 auto;
    display:grid;
    place-items:center;
  }
  .thumb-wrap canvas {
    width:100%;
    height:100%;
    object-fit:cover;
  }
  .thumb-wrap.zoomable { cursor: zoom-in; }
  .thumb-wrap.zoomable:hover {
    transform:scale(1.08);
    transition:transform .2s ease;
  }
  .single-preview {
    margin-top:10px;
    display:none;
    align-items:flex-start;
    gap:10px;
    padding:10px;
    border:1px solid #d9eaed;
    border-radius:12px;
    background:#fff;
  }
  .single-preview.show { display:flex; }
  .single-meta { min-width:0; }
  .single-name {
    margin:0;
    font-size:12px;
    color:#35535d;
    line-height:1.4;
    max-width:240px;
    white-space:nowrap;
    text-overflow:ellipsis;
    overflow:hidden;
  }
  .single-note {
    margin:4px 0 0;
    font-size:11px;
    color:#6a7a7d;
  }
  .thumb-modal {
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.55);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:1300;
    padding:20px;
  }
  .thumb-modal.show { display:flex; }
  .thumb-modal-card {
    width:min(90vw,500px);
    border-radius:12px;
    background:#fff;
    padding:14px;
  }
  .thumb-modal canvas {
    width:100%;
    max-height:72vh;
    object-fit:contain;
    border:1px solid #d9eaed;
    border-radius:8px;
    background:#f3f8fa;
  }
  .merge-meta { min-width:0; flex:1; }
  .merge-name {
    margin:0;
    font-size:13px;
    line-height:1.35;
    color:#263a40;
    overflow:hidden;
    white-space:nowrap;
    text-overflow:ellipsis;
  }
  .merge-name.expanded {
    white-space:normal;
    word-break:break-all;
  }
  .merge-order {
    margin:4px 0 0;
    font-size:11px;
    color:#66808a;
  }
  .merge-actions {
    display:flex;
    align-items:center;
    gap:8px;
  }
  .mini-btn {
    border:1px solid #ccdce0;
    border-radius:10px;
    background:#fff;
    color:#35535d;
    font-size:11px;
    font-weight:700;
    padding:6px 8px;
    cursor:pointer;
  }
  .drag-handle {
    color:#6a8790;
    font-weight:900;
    font-size:18px;
    user-select:none;
  }
  .merge-empty {
    margin-top:10px;
    font-size:12px;
    color:#6a7a7d;
  }
  
  .input-text, .input-num {
    background:#f8fcfd; border:1px solid #d9eaed;
    border-radius:12px; padding:12px 14px;
    font-size:16px; color:var(--ink); width:100%; box-sizing: border-box;
    transition: border-color .28s ease, box-shadow .28s ease;
  }
  .input-text:focus, .input-num:focus {
    outline: none; border-color: #578899;
    box-shadow: 0 0 0 2px rgba(87,136,153,.15);
  }
  .flex-row { display: flex; align-items: center; gap: 10px; }
  .flex-row .input-num { flex: 1; text-align: center; font-weight: bold; }
  .flex-row span { font-weight: bold; color: var(--muted); }

  /* buttons */
  .btn{
    background:linear-gradient(180deg,#7aa2b0,#578899);
    color:#fff;font-weight:900;border:0;width:100%;
    border-radius:12px;padding:16px 18px;font-size:16px;
    box-shadow:0 10px 30px rgba(35,80,90,.12);
    cursor: pointer;
    transition: transform 0.1s;
    margin-top: 4px;
  }
  .btn:active{transform:translateY(1px)}

  /* Toast notification */
  .sys-toast{
    position:fixed; left:50%; bottom:calc(80px + env(safe-area-inset-bottom)); top:auto; transform:translateX(-50%) translateY(8px);
    z-index:1200; padding:12px 20px; border-radius:999px;
    border:1px solid rgba(87,136,153,.35); background:#fff;
    box-shadow:0 12px 30px rgba(20,40,50,.12); font-size:14px; font-weight:900;
    color:#1e2a2d; opacity:0; pointer-events:none;
    transition:.18s transform,.18s opacity;
    max-width:min(92vw,560px); white-space:nowrap;
  }
  .sys-toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }
  .action-status{margin:8px 6px 0; font-size:12px; color:#4f6570;}
  .action-status.error{color:#e74c3c; font-weight:700;}

  /* footer */
  .mk-mini{ margin:24px 4px 6px; text-align:center;color:#667; font-size:11px;line-height:1.6; }
  .mk-mini a{ color:inherit; text-decoration:underline; text-underline-offset:2px; }
  .mk-rev{display:block; margin-top:4px; font-weight:700; color:#4f6570;}

  /* sticky nav */
  .mk-nav{position:fixed; left:0; right:0; bottom:0; z-index:999; padding:10px 12px calc(10px + env(safe-area-inset-bottom)); background:rgba(255,255,255,.92); border-top:1px solid var(--mk-line); backdrop-filter:saturate(180%) blur(10px);}
  .mk-nav .inner{max-width:1100px; margin:0 auto; display:flex; gap:10px; align-items:center; justify-content:space-between;}
  .mk-nav .left{display:flex; flex-direction:column; gap:2px; min-width:0;}
  .mk-nav .hint{font-size:11px; color:var(--mk-muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .mk-nav .btns{display:flex; gap:8px; flex:0 0 auto;}
  .mk-nav a{display:inline-flex; align-items:center; justify-content:center; height:36px; padding:0 12px; border-radius:12px; border:1px solid var(--mk-line); text-decoration:none; font-weight:800; color:var(--mk-ink); background:#fff;}
  .mk-nav a.primary{border-color:transparent; background:linear-gradient(135deg, var(--mk-brand) 0%, #7aa5b4 100%); color:#fff;}
</style>
</head>
<body>

<div class="sys-toast" id="sysToast" role="status" aria-live="polite">å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ</div>

<div class="wrap">
  <header>
    <div class="brand">
      <a class="logo-link" href="https://takatrp.github.io/tool-portal/" target="_blank" rel="noopener">
        <img src="ãƒ­ã‚´.jpg" alt="æ¾æœ¬ä¼šè¨ˆäº‹å‹™æ‰€ãƒ­ã‚´" class="logo" onerror="this.style.display='none'" />
      </a>
      <h1 class="title">å®‰å¿ƒpdfãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</h1>
    </div>
    <div class="subtitle">
      é¡§å•å…ˆæ§˜ã®æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ã‚’å®ˆã‚‹ãŸã‚ã€ã‚µãƒ¼ãƒãƒ¼ã¸ã¯ä¸€åˆ‡é€ä¿¡ã›ãšã€ãŠä½¿ã„ã®ç«¯æœ«ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼‰ã ã‘ã§å®‰å…¨ã«PDFã‚’å‡¦ç†ã—ã¾ã™ã€‚
    </div>
  </header>
  <div id="action-status" class="action-status" aria-live="polite">æº–å‚™å®Œäº†</div>


  <section class="card">
    <div class="field">
      <div class="label big">ğŸ“‘ 1. çµåˆ (Merge)</div>
      <div class="helper">è¤‡æ•°ã®PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’1ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¾ã¨ã‚ã¾ã™ã€‚</div>
      <div class="file-box" id="merge-dropzone">
        <input type="file" id="merge-files" accept="application/pdf" multiple>
        <div class="drop-hint">ã“ã“ã«PDFã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦è¿½åŠ ã§ãã¾ã™ã€‚</div>
      </div>
      <div class="merge-empty" id="merge-empty">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’2ã¤ä»¥ä¸Šè¿½åŠ ã™ã‚‹ã¨çµåˆã§ãã¾ã™ã€‚</div>
      <div class="merge-list" id="merge-list" aria-live="polite"></div>
    </div>
    <button class="btn" onclick="handleMerge()">çµåˆã—ã¦ä¿å­˜</button>
  </section>

  <section class="card">
    <div class="field">
      <div class="label big">âœ‚ï¸ 2. åˆ†è§£ãƒ»æŠ½å‡º (Extract)</div>
      <div class="helper">å…ƒã®PDFã‹ã‚‰ã€æŒ‡å®šã—ãŸãƒšãƒ¼ã‚¸ç¯„å›²ã ã‘ã‚’åˆ‡ã‚Šå‡ºã—ã¾ã™ã€‚</div>
      <div class="file-box" id="extract-dropzone">
        <input type="file" id="extract-file" accept="application/pdf">
        <div class="drop-hint">ã“ã“ã«PDFã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦è¿½åŠ ã§ãã¾ã™ã€‚</div>
      </div>
      <div class="single-preview" id="extract-preview"></div>
    </div>
    <div class="field">
      <div class="flex-row">
        <input type="number" id="extract-start" class="input-num" min="1" value="1" placeholder="é–‹å§‹">
        <span>ã€œ</span>
        <input type="number" id="extract-end" class="input-num" min="1" value="1" placeholder="çµ‚äº†">
        <span>ãƒšãƒ¼ã‚¸</span>
      </div>
    </div>
    <button class="btn" onclick="handleExtract()">æŠ½å‡ºã—ã¦ä¿å­˜</button>
  </section>

  <section class="card">
    <div class="field">
      <div class="label big">â• 3. ãƒšãƒ¼ã‚¸è¿½åŠ  (Insert)</div>
      <div class="helper">ãƒ™ãƒ¼ã‚¹ã¨ãªã‚‹PDFã®æŒ‡å®šã—ãŸä½ç½®ã«ã€åˆ¥ã®PDFã‚’æŒ¿å…¥ã—ã¾ã™ã€‚</div>
      <div class="file-box" id="insert-base-dropzone" style="margin-bottom:10px;">
        <div class="helper" style="margin:0 0 4px;">ãƒ™ãƒ¼ã‚¹ã®PDF</div>
        <input type="file" id="insert-base-file" accept="application/pdf">
        <div class="drop-hint">ã“ã“ã«PDFã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦è¿½åŠ ã§ãã¾ã™ã€‚</div>
      </div>
      <div class="single-preview" id="insert-base-preview" style="margin-bottom:10px;"></div>
      <div class="file-box" id="insert-add-dropzone">
        <div class="helper" style="margin:0 0 4px;">æŒ¿å…¥ã—ãŸã„PDF</div>
        <input type="file" id="insert-add-file" accept="application/pdf">
        <div class="drop-hint">ã“ã“ã«PDFã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦è¿½åŠ ã§ãã¾ã™ã€‚</div>
      </div>
      <div class="single-preview" id="insert-add-preview"></div>
    </div>
    <div class="field">
      <div class="flex-row">
        <span>æŒ¿å…¥ä½ç½®ï¼š</span>
        <input type="number" id="insert-position" class="input-num" min="1" value="2" style="max-width: 100px;">
        <span>ãƒšãƒ¼ã‚¸ç›®ã¨ã—ã¦</span>
      </div>
    </div>
    <button class="btn" onclick="handleInsert()">è¿½åŠ ã—ã¦ä¿å­˜</button>
  </section>

  <section class="card">
    <div class="field">
      <div class="label big">ğŸ—‘ï¸ 4. ãƒšãƒ¼ã‚¸å‰Šé™¤ (Delete)</div>
      <div class="helper">æŒ‡å®šã—ãŸä¸è¦ãªãƒšãƒ¼ã‚¸ã‚’å–ã‚Šé™¤ãã¾ã™ã€‚</div>
      <div class="file-box" id="delete-dropzone">
        <input type="file" id="delete-file" accept="application/pdf">
        <div class="drop-hint">ã“ã“ã«PDFã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦è¿½åŠ ã§ãã¾ã™ã€‚</div>
      </div>
      <div class="single-preview" id="delete-preview"></div>
    </div>
    <div class="field">
      <div class="flex-row">
        <span>å‰Šé™¤ã™ã‚‹ãƒšãƒ¼ã‚¸ï¼š</span>
        <input type="number" id="delete-page" class="input-num" min="1" value="1" style="max-width: 100px;">
      </div>
    </div>
    <button class="btn" onclick="handleDelete()">å‰Šé™¤ã—ã¦ä¿å­˜</button>
  </section>

  <footer class="mk-mini">
    Â© <span id="cpy-year">2025</span>
    <a href="https://www.matsumoto-kaikei.or.jp/" target="_blank" rel="noopener">ç¨ç†å£«æ³•äººæ¾æœ¬ä¼šè¨ˆäº‹å‹™æ‰€</a>
    <span class="mk-rev">å®‰å¿ƒpdfãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ rev. r6</span>
  </footer>
</div>

<div class="mk-nav" id="mk-nav">
  <div class="inner">
    <div class="left">
      <div style="font-weight:900;">æ¾æœ¬ä¼šè¨ˆãƒ„ãƒ¼ãƒ«</div>
      <div class="hint">ãƒãƒ¼ã‚¿ãƒ«ã¸æˆ»ã‚‹</div>
    </div>
    <div class="btns">
      <a href="https://takatrp.github.io/tool-portal/" id="mk-back">â† ãƒãƒ¼ã‚¿ãƒ«</a>
    </div>
  </div>
</div>

<div class="thumb-modal" id="thumb-modal" role="dialog" aria-label="PDFã‚µãƒ ãƒã‚¤ãƒ«æ‹¡å¤§è¡¨ç¤º">
  <div class="thumb-modal-card">
    <canvas id="thumb-modal-canvas"></canvas>
    <div class="single-note" style="margin-top:8px;">ã‚¿ãƒƒãƒ—ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã¾ã™ã€‚</div>
  </div>
</div>

<script>
  // å¹´åº¦è‡ªå‹•æ›´æ–°
  document.getElementById('cpy-year').textContent = new Date().getFullYear();

  const { PDFDocument } = PDFLib;
  const mergeFilesState = [];
  const mergeInput = document.getElementById('merge-files');
  const mergeDropzone = document.getElementById('merge-dropzone');
  const mergeListEl = document.getElementById('merge-list');
  const mergeEmptyEl = document.getElementById('merge-empty');
  const sysToastEl = document.getElementById('sysToast');
  const thumbModalEl = document.getElementById('thumb-modal');
  const thumbModalCanvas = document.getElementById('thumb-modal-canvas');

  let pdfjsLibPromise;

  async function getPdfJsLib() {
    if (!pdfjsLibPromise) {
      pdfjsLibPromise = import('https://unpkg.com/pdfjs-dist@4.5.136/build/pdf.min.mjs').then((pdfjsLib) => {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@4.5.136/build/pdf.worker.min.mjs';
        return pdfjsLib;
      });
    }
    return pdfjsLibPromise;
  }

  let pdfjsLibPromise;

  async function getPdfJsLib() {
    if (!pdfjsLibPromise) {
      pdfjsLibPromise = import('https://unpkg.com/pdfjs-dist@4.5.136/build/pdf.min.mjs').then((pdfjsLib) => {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@4.5.136/build/pdf.worker.min.mjs';
        return pdfjsLib;
      });
    }
    return pdfjsLibPromise;
  }

  // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
  function showToast(msg, isError = false) {
    sysToastEl.textContent = msg;
    sysToastEl.style.color = isError ? '#e74c3c' : '#1e2a2d';
    sysToastEl.style.borderColor = isError ? '#e74c3c' : 'rgba(87,136,153,.35)';
    actionStatusEl.textContent = msg;
    actionStatusEl.classList.toggle('error', isError);
    sysToastEl.classList.add('show');
    clearTimeout(showToast._timer);
    showToast._timer = setTimeout(() => {
      sysToastEl.classList.remove('show');
    }, 3000);
  }

  async function readFileAsArrayBuffer(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsArrayBuffer(file);
    });
  }

  function downloadPDF(pdfBytes, filename) {
    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
    showToast('å‡¦ç†ãŒå®Œäº†ã—ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚');
  }

  function setSingleFileToInput(inputEl, file) {
    const dt = new DataTransfer();
    dt.items.add(file);
    inputEl.files = dt.files;
  }

  function bindDropzoneFileInput({ inputId, dropzoneId, previewId, noteText }) {
    const inputEl = document.getElementById(inputId);
    const dropzoneEl = document.getElementById(dropzoneId);
    const previewEl = document.getElementById(previewId);
    if (!inputEl || !dropzoneEl || !previewEl) return;

    const renderSinglePreview = async () => {
      const file = inputEl.files[0];
      if (!file) {
        previewEl.classList.remove('show');
        previewEl.innerHTML = '';
        return;
      }
      previewEl.classList.add('show');
      previewEl.innerHTML = '';

      const thumbWrap = document.createElement('div');
      thumbWrap.className = 'thumb-wrap zoomable';
      const canvas = document.createElement('canvas');
      thumbWrap.appendChild(canvas);
      thumbWrap.addEventListener('click', async () => {
        await renderPdfThumbnail(file, thumbModalCanvas);
        thumbModalEl.classList.add('show');
      });

      const meta = document.createElement('div');
      meta.className = 'single-meta';
      const name = document.createElement('p');
      name.className = 'single-name';
      name.textContent = file.name;
      name.title = file.name;
      const note = document.createElement('p');
      note.className = 'single-note';
      note.textContent = noteText;
      meta.append(name, note);

      previewEl.append(thumbWrap, meta);
      await renderPdfThumbnail(file, canvas);
    };

    inputEl.addEventListener('change', renderSinglePreview);
    ['dragenter', 'dragover'].forEach((eventName) => {
      dropzoneEl.addEventListener(eventName, (e) => {
        e.preventDefault();
        dropzoneEl.classList.add('dragover');
      });
    });
    ['dragleave', 'drop'].forEach((eventName) => {
      dropzoneEl.addEventListener(eventName, (e) => {
        e.preventDefault();
        dropzoneEl.classList.remove('dragover');
      });
    });
    dropzoneEl.addEventListener('drop', (e) => {
      const files = Array.from(e.dataTransfer.files).filter((file) => file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf'));
      if (!files.length) return;
      setSingleFileToInput(inputEl, files[0]);
      renderSinglePreview();
    });
  }

  async function renderPdfThumbnail(file, canvas) {
    try {
      const pdfjsLib = await getPdfJsLib();
      const arrayBuffer = await readFileAsArrayBuffer(file);
      const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
      const pdf = await loadingTask.promise;
      const page = await pdf.getPage(1);
      const viewport = page.getViewport({ scale: 1 });
      const scale = Math.min(88 / viewport.width, 120 / viewport.height);
      const scaledViewport = page.getViewport({ scale });
      canvas.width = scaledViewport.width;
      canvas.height = scaledViewport.height;
      const ctx = canvas.getContext('2d');
      await page.render({ canvasContext: ctx, viewport: scaledViewport }).promise;
    } catch (err) {
      const ctx = canvas.getContext('2d');
      canvas.width = 88;
      canvas.height = 120;
      ctx.fillStyle = '#eff5f7';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#577783';
      ctx.font = 'bold 11px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('PDF', canvas.width / 2, canvas.height / 2 + 4);
    }
  }

  function syncMergeVisibility() {
    mergeEmptyEl.style.display = mergeFilesState.length ? 'none' : 'block';
  }

  function renderMergeList() {
    mergeListEl.innerHTML = '';
    mergeFilesState.forEach((item, index) => {
      const row = document.createElement('div');
      row.className = 'merge-item';
      row.draggable = true;
      row.dataset.index = index;

      const thumbWrap = document.createElement('div');
      thumbWrap.className = 'thumb-wrap';
      const canvas = document.createElement('canvas');
      thumbWrap.appendChild(canvas);
      thumbWrap.classList.add('zoomable');
      thumbWrap.addEventListener('click', async () => {
        await renderPdfThumbnail(item.file, thumbModalCanvas);
        thumbModalEl.classList.add('show');
      });

      const meta = document.createElement('div');
      meta.className = 'merge-meta';
      const name = document.createElement('p');
      name.className = 'merge-name';
      name.textContent = item.file.name;
      name.title = item.file.name;
      const order = document.createElement('p');
      order.className = 'merge-order';
      order.textContent = `${index + 1}ç•ªç›®ã«çµåˆã•ã‚Œã¾ã™`;

      meta.append(name, order);

      const actions = document.createElement('div');
      actions.className = 'merge-actions';

      const toggleBtn = document.createElement('button');
      toggleBtn.className = 'mini-btn';
      toggleBtn.textContent = item.expanded ? 'æŠ˜ã‚ŠãŸãŸã‚€' : 'å…¨æ–‡';
      toggleBtn.type = 'button';
      toggleBtn.addEventListener('click', () => {
        item.expanded = !item.expanded;
        renderMergeList();
      });

      const removeBtn = document.createElement('button');
      removeBtn.className = 'mini-btn';
      removeBtn.textContent = 'å‰Šé™¤';
      removeBtn.type = 'button';
      removeBtn.addEventListener('click', () => {
        mergeFilesState.splice(index, 1);
        renderMergeList();
      });

      const handle = document.createElement('span');
      handle.className = 'drag-handle';
      handle.textContent = 'â‹®â‹®';
      handle.title = 'ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆ';

      if (item.expanded) name.classList.add('expanded');

      actions.append(toggleBtn, removeBtn, handle);
      row.append(thumbWrap, meta, actions);
      mergeListEl.appendChild(row);
      renderPdfThumbnail(item.file, canvas);
    });

    syncMergeVisibility();
  }

  function addFilesToMergeState(fileList) {
    const files = Array.from(fileList).filter((file) => file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf'));
    files.forEach((file) => {
      mergeFilesState.push({ file, expanded: false });
    });
    renderMergeList();
  }

  mergeInput.addEventListener('change', (e) => {
    addFilesToMergeState(e.target.files);
    mergeInput.value = '';
  });

  ['dragenter', 'dragover'].forEach((eventName) => {
    mergeDropzone.addEventListener(eventName, (e) => {
      e.preventDefault();
      mergeDropzone.classList.add('dragover');
    });
  });
  ['dragleave', 'drop'].forEach((eventName) => {
    mergeDropzone.addEventListener(eventName, (e) => {
      e.preventDefault();
      mergeDropzone.classList.remove('dragover');
    });
  });
  mergeDropzone.addEventListener('drop', (e) => {
    addFilesToMergeState(e.dataTransfer.files);
  });

  mergeListEl.addEventListener('dragstart', (e) => {
    const row = e.target.closest('.merge-item');
    if (!row) return;
    row.classList.add('dragging');
    e.dataTransfer.setData('text/plain', row.dataset.index);
  });

  mergeListEl.addEventListener('dragend', (e) => {
    const row = e.target.closest('.merge-item');
    if (row) row.classList.remove('dragging');
  });

  mergeListEl.addEventListener('dragover', (e) => {
    e.preventDefault();
  });

  mergeListEl.addEventListener('drop', (e) => {
    e.preventDefault();
    const target = e.target.closest('.merge-item');
    if (!target) return;
    const draggingIndex = Number(e.dataTransfer.getData('text/plain'));
    const targetIndex = Number(target.dataset.index);
    if (Number.isNaN(draggingIndex) || Number.isNaN(targetIndex) || draggingIndex === targetIndex) return;

    const [moved] = mergeFilesState.splice(draggingIndex, 1);
    mergeFilesState.splice(targetIndex, 0, moved);
    renderMergeList();
  });

  thumbModalEl.addEventListener('click', () => {
    thumbModalEl.classList.remove('show');
  });

  bindDropzoneFileInput({ inputId: 'extract-file', dropzoneId: 'extract-dropzone', previewId: 'extract-preview', noteText: 'æŠ½å‡ºå¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«' });
  bindDropzoneFileInput({ inputId: 'insert-base-file', dropzoneId: 'insert-base-dropzone', previewId: 'insert-base-preview', noteText: 'æŒ¿å…¥å…ˆï¼ˆãƒ™ãƒ¼ã‚¹ï¼‰ãƒ•ã‚¡ã‚¤ãƒ«' });
  bindDropzoneFileInput({ inputId: 'insert-add-file', dropzoneId: 'insert-add-dropzone', previewId: 'insert-add-preview', noteText: 'æŒ¿å…¥å…ƒãƒ•ã‚¡ã‚¤ãƒ«' });
  bindDropzoneFileInput({ inputId: 'delete-file', dropzoneId: 'delete-dropzone', previewId: 'delete-preview', noteText: 'å‰Šé™¤å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«' });

  // --- 1. çµåˆ ---
  async function handleMerge() {
    if (mergeFilesState.length < 2) return showToast('2ã¤ä»¥ä¸Šã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', true);
    
    showToast('å‡¦ç†ä¸­...');
    try {
      const mergedPdf = await PDFDocument.create();
      for (let { file } of mergeFilesState) {
        const bytes = await readFileAsArrayBuffer(file);
        const pdf = await PDFDocument.load(bytes);
        const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
        copiedPages.forEach((page) => mergedPdf.addPage(page));
      }
      const pdfBytes = await mergedPdf.save();
      downloadPDF(pdfBytes, 'merged_document.pdf');
    } catch (e) {
      showToast('ã‚¨ãƒ©ãƒ¼: ä¿è­·ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒå«ã¾ã‚Œã¦ã„ãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚', true);
    }
  }

  // --- 2. æŠ½å‡º ---
  async function handleExtract() {
    const file = getSelectedSingleFile('extract-file');
    const start = parseInt(document.getElementById('extract-start').value);
    const end = parseInt(document.getElementById('extract-end').value);
    
    if (!file) return showToast('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', true);
    if (start > end || start < 1) return showToast('æ­£ã—ã„ãƒšãƒ¼ã‚¸ç¯„å›²ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚', true);

    showToast('å‡¦ç†ä¸­...');
    try {
      const bytes = await readFileAsArrayBuffer(file);
      const sourcePdf = await PDFDocument.load(bytes);
      const totalPages = sourcePdf.getPageCount();

      if (end > totalPages) return showToast(`ã“ã®PDFã¯${totalPages}ãƒšãƒ¼ã‚¸ã¾ã§ã§ã™ã€‚`, true);

      const newPdf = await PDFDocument.create();
      const indices = Array.from({ length: end - start + 1 }, (_, i) => (start - 1) + i);
      const copiedPages = await newPdf.copyPages(sourcePdf, indices);
      copiedPages.forEach((page) => newPdf.addPage(page));

      const pdfBytes = await newPdf.save();
      downloadPDF(pdfBytes, `extracted_${start}-${end}.pdf`);
    } catch (e) {
      showToast('ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¿è­·ã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚', true);
    }
  }

  // --- 3. è¿½åŠ  ---
  async function handleInsert() {
    const baseFile = getSelectedSingleFile('insert-base-file');
    const addFile = getSelectedSingleFile('insert-add-file');
    const position = parseInt(document.getElementById('insert-position').value);

    if (!baseFile || !addFile) return showToast('2ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', true);
    if (position < 1) return showToast('æ­£ã—ã„ãƒšãƒ¼ã‚¸ä½ç½®ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚', true);

    showToast('å‡¦ç†ä¸­...');
    try {
      const baseBytes = await readFileAsArrayBuffer(baseFile);
      const addBytes = await readFileAsArrayBuffer(addFile);
      const basePdf = await PDFDocument.load(baseBytes);
      const addPdf = await PDFDocument.load(addBytes);
      
      const totalPages = basePdf.getPageCount();
      let insertIndex = position - 1;
      if (insertIndex > totalPages) insertIndex = totalPages;

      const copiedPages = await basePdf.copyPages(addPdf, addPdf.getPageIndices());
      copiedPages.forEach((page, index) => {
        basePdf.insertPage(insertIndex + index, page);
      });

      const pdfBytes = await basePdf.save();
      downloadPDF(pdfBytes, 'inserted_document.pdf');
    } catch (e) {
      showToast('ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¿è­·ã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚', true);
    }
  }

  // --- 4. å‰Šé™¤ ---
  async function handleDelete() {
    const file = getSelectedSingleFile('delete-file');
    const pageNum = parseInt(document.getElementById('delete-page').value);

    if (!file) return showToast('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', true);
    if (pageNum < 1) return showToast('æ­£ã—ã„ãƒšãƒ¼ã‚¸ç•ªå·ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚', true);

    showToast('å‡¦ç†ä¸­...');
    try {
      const bytes = await readFileAsArrayBuffer(file);
      const pdf = await PDFDocument.load(bytes);
      const totalPages = pdf.getPageCount();
      
      if (pageNum > totalPages) return showToast(`ã“ã®PDFã¯${totalPages}ãƒšãƒ¼ã‚¸ã¾ã§ã§ã™ã€‚`, true);

      pdf.removePage(pageNum - 1); 
      const pdfBytes = await pdf.save();
      downloadPDF(pdfBytes, 'deleted_document.pdf');
    } catch (e) {
      showToast('ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¿è­·ã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚', true);
    }
  }
</script>
</body>
</html>
