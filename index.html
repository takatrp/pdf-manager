<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ã‚»ã‚­ãƒ¥ã‚¢PDFãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï½œæ¾æœ¬ä¼šè¨ˆäº‹å‹™æ‰€</title>

<meta name="theme-color" content="#578899" />
<link rel="icon" type="image/png" sizes="192x192" href="favicon192192.png" />
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

<style>
  :root {
    --bg:#f4f9fb; --card:#fff; --ink:#1e2a2d; --muted:#5a6a6d;
    --accent:#578899; --accent-2:#7aa2b0; --shadow:0 10px 30px rgba(35,80,90,.12);
    --warn: #e74c3c; --success: #27ae60;
    --mk-brand:#578899; --mk-line:#e2e8f0; --mk-ink:#0f172a; --mk-muted:#64748b;
  }
  html,body{height:100%}
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN","Yu Gothic","Noto Sans JP",Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg);
    color:var(--ink);
    padding-bottom: calc(140px + env(safe-area-inset-bottom));
  }
  .wrap{
    padding:max(12px,env(safe-area-inset-top)) max(14px,env(safe-area-inset-right)) calc(16px + env(safe-area-inset-bottom)) max(14px,env(safe-area-inset-left));
    max-width:560px;
    margin:0 auto;
  }

  /* header */
  header{padding:8px 6px 2px}
  .brand{display:flex;align-items:center;gap:10px}
  .logo-link{display:inline-flex;line-height:0;text-decoration:none}
  .logo{height:48px;width:auto;object-fit:contain}
  .title{
    flex:1;min-width:0;white-space:nowrap;margin:0;
    font-weight:800;letter-spacing:.02em;line-height:1.2;
    font-size:clamp(16px,4.6vw,22px);color:#0e2430;
  }
  .subtitle{color:#5a6a6d;font-size:12px;margin:6px 0 0; line-height: 1.5;}

  /* card & fields */
  .card{
    background:#fff;border-radius:16px;
    box-shadow:0 10px 30px rgba(35,80,90,.12);
    padding:20px 16px;margin:16px 0;
  }
  .field{margin:0 0 20px}
  .field:last-child { margin-bottom: 0; }
  .label.big{font-size:16px;font-weight:800;color:#324245; margin-bottom: 8px;}
  .helper{font-size:12px;color:#6a7a7d;margin:4px 0 8px; line-height: 1.4;}

  /* Inputs (ãƒˆãƒ³ãƒãƒŠã«åˆã‚ã›ãŸãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›æ ) */
  .file-box {
    background:#f8fcfd; border: 2px dashed #7aa2b0;
    border-radius:12px; padding:16px;
    min-height:112px;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:10px;
    text-align:center;
    transition: background-color .28s ease, border-color .28s ease;
  }
  .file-box:hover { background: #eef7f8; border-color: #578899; }
  .file-box input[type="file"] {
    width:min(100%, 360px);
    font-size:14px;
    color:var(--ink);
    cursor:pointer;
    margin:0 auto;
  }
  .file-box.dragover {
    background:#e9f4f7;
    border-color:#3e6f80;
  }
  .drop-hint {
    font-size:12px;
    color:#4f6570;
    margin-top:0;
    text-align:center;
  }
  .merge-list {
    margin-top:12px;
    display:grid;
    gap:10px;
  }
  .merge-item {
    position:relative;
    display:flex;
    align-items:center;
    gap:12px;
    padding:38px 10px 10px;
    border:1px solid #d9eaed;
    border-radius:12px;
    background:#fff;
  }
  .thumb-wrap {
    width:88px;
    height:120px;
    border-radius:8px;
    border:1px solid #ccdce0;
    overflow:hidden;
    background:#f3f8fa;
    flex:0 0 auto;
    display:grid;
    place-items:center;
  }
  .thumb-wrap canvas {
    width:100%;
    height:100%;
    object-fit:cover;
  }
  .thumb-wrap.zoomable { cursor: zoom-in; }
  .thumb-wrap.zoomable:hover {
    transform:scale(1.08);
    transition:transform .2s ease;
  }
  .single-preview {
    margin-top:10px;
    display:none;
    align-items:flex-start;
    gap:10px;
    padding:10px;
    border:1px solid #d9eaed;
    border-radius:12px;
    background:#fff;
  }
  .single-preview.show { display:flex; }
  .single-preview.multi-pages {
    display:block;
  }
  .single-preview-header {
    display:flex;
    align-items:flex-start;
    gap:10px;
    margin-bottom:10px;
  }
  .single-pages-grid {
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(88px,1fr));
    gap:10px;
  }
  .single-page-item {
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:4px;
  }
  .single-page-item .thumb-wrap {
    width:100%;
    max-width:110px;
    aspect-ratio: 11 / 15;
    height:auto;
  }
  .single-page-number {
    margin:0;
    font-size:11px;
    color:#66808a;
  }
  .single-page-actions {
    display:flex;
    gap:6px;
  }
  .single-page-btn {
    border:1px solid #ccdce0;
    border-radius:8px;
    background:#fff;
    color:#35535d;
    font-size:10px;
    font-weight:800;
    padding:4px 6px;
    cursor:pointer;
  }
  .single-page-item.selected .thumb-wrap {
    border:2px solid #578899;
    box-shadow:0 0 0 2px rgba(87,136,153,.2);
  }
  .single-page-item.selected .single-page-number {
    color:#2d5a67;
    font-weight:800;
  }
  .single-meta { min-width:0; }
  .single-name {
    margin:0;
    font-size:12px;
    color:#35535d;
    line-height:1.4;
    max-width:240px;
    white-space:nowrap;
    text-overflow:ellipsis;
    overflow:hidden;
  }
  .single-note {
    margin:4px 0 0;
    font-size:11px;
    color:#6a7a7d;
  }
  .thumb-modal {
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.55);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:1300;
    padding:20px;
  }
  .thumb-modal.show { display:flex; }
  .thumb-modal-card {
    width:min(96vw,920px);
    border-radius:12px;
    background:#fff;
    padding:14px;
  }
  .thumb-modal canvas {
    width:100%;
    max-height:72vh;
    object-fit:contain;
    border:1px solid #d9eaed;
    border-radius:8px;
    background:#f3f8fa;
  }
  .merge-meta { min-width:0; flex:1; overflow:hidden; }
  .merge-name {
    margin:0;
    display:block;
    max-width:100%;
    font-size:13px;
    line-height:1.35;
    color:#263a40;
    overflow:hidden;
    white-space:nowrap;
    text-overflow:ellipsis;
  }
  .merge-fullname {
    margin:8px 0 0;
    padding:8px;
    border-radius:8px;
    background:#f6fbfc;
    color:#27424a;
    font-size:12px;
    line-height:1.4;
    overflow-wrap:anywhere;
  }
  .merge-name.expanded {
    white-space:normal;
    word-break:break-all;
  }
  .merge-order-badge {
    position:absolute;
    left:10px;
    top:10px;
    margin:0;
    padding:4px 8px;
    border-radius:999px;
    background:#e9f4f7;
    color:#2d5a67;
    font-size:13px;
    font-weight:900;
  }
  .merge-actions {
    display:flex;
    align-items:center;
    gap:8px;
  }
  .merge-move {
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .mini-btn {
    border:1px solid #ccdce0;
    border-radius:10px;
    background:#fff;
    color:#35535d;
    font-size:11px;
    font-weight:700;
    padding:6px 8px;
    cursor:pointer;
  }
  .mini-btn.move-btn {
    min-width:34px;
    padding:4px 8px;
    font-size:14px;
    line-height:1;
  }
  .mini-btn:disabled {
    opacity:.45;
    cursor:not-allowed;
  }
  .merge-empty {
    margin-top:10px;
    font-size:12px;
    color:#6a7a7d;
  }
  
  .input-text, .input-num {
    background:#f8fcfd; border:1px solid #d9eaed;
    border-radius:12px; padding:12px 14px;
    font-size:16px; color:var(--ink); width:100%; box-sizing: border-box;
    transition: border-color .28s ease, box-shadow .28s ease;
  }
  .input-text:focus, .input-num:focus {
    outline: none; border-color: #578899;
    box-shadow: 0 0 0 2px rgba(87,136,153,.15);
  }
  .flex-row { display: flex; align-items: center; gap: 10px; }
  .flex-row .input-num { flex: 1; text-align: center; font-weight: bold; }
  .flex-row span { font-weight: bold; color: var(--muted); }

  /* buttons */
  .btn{
    background:linear-gradient(180deg,#7aa2b0,#578899);
    color:#fff;font-weight:900;border:0;width:100%;
    border-radius:12px;padding:16px 18px;font-size:16px;
    box-shadow:0 10px 30px rgba(35,80,90,.12);
    cursor: pointer;
    transition: transform 0.1s;
    margin-top: 4px;
  }
  .btn:active{transform:translateY(1px)}

  /* Toast notification */
  .sys-toast{
    position:fixed; left:50%; bottom:calc(80px + env(safe-area-inset-bottom)); top:auto; transform:translateX(-50%) translateY(8px);
    z-index:1200; padding:12px 20px; border-radius:999px;
    border:1px solid rgba(87,136,153,.35); background:#fff;
    box-shadow:0 12px 30px rgba(20,40,50,.12); font-size:14px; font-weight:900;
    color:#1e2a2d; opacity:0; pointer-events:none;
    transition:.18s transform,.18s opacity;
    max-width:min(92vw,560px); white-space:nowrap;
  }
  .sys-toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }
  .action-status{margin:8px 6px 0; font-size:12px; color:#4f6570;}
  .action-status.error{color:#e74c3c; font-weight:700;}
  .feature-home {
    display:grid;
    gap:12px;
    grid-template-columns:repeat(2, minmax(0, 1fr));
  }
  .feature-link-btn {
    width:100%;
    min-height:120px;
    text-align:center;
    border:1px solid #d9eaed;
    border-radius:16px;
    background:#fff;
    color:#27424a;
    padding:14px 12px;
    font-size:16px;
    font-weight:800;
    cursor:pointer;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:8px;
    box-shadow:0 8px 20px rgba(35,80,90,.08);
  }
  .feature-link-btn .feature-icon {
    font-size:30px;
    line-height:1;
  }
  .feature-link-btn .feature-text {
    font-size:15px;
    line-height:1.35;
  }
  .feature-back {
    margin:8px 0 2px;
    display:none;
  }
  .feature-back.show { display:block; }
  .feature-back-btn {
    border:1px solid #ccdce0;
    border-radius:999px;
    background:#fff;
    color:#35535d;
    font-weight:800;
    font-size:12px;
    padding:7px 12px;
    cursor:pointer;
  }
  .feature-panel { display:none; }
  .feature-panel.active { display:block; }

  /* footer */
  .mk-mini{
    margin:14px 0 calc(96px + env(safe-area-inset-bottom));
    font-size:12px;
    color:#334155;
    display:flex;
    justify-content:center;
    gap:6px;
    flex-wrap:wrap;
    text-align:center;
  }
  .mk-mini a{ color:inherit; text-decoration:underline; text-underline-offset:2px; }

  /* sticky nav */
  .mk-nav{position:fixed; left:0; right:0; bottom:0; z-index:999; padding:10px 12px calc(10px + env(safe-area-inset-bottom)); background:rgba(255,255,255,.92); border-top:1px solid var(--mk-line); backdrop-filter:saturate(180%) blur(10px);}
  .mk-nav .inner{max-width:1100px; margin:0 auto; display:flex; gap:10px; align-items:center; justify-content:space-between;}
  .mk-nav .left{display:flex; flex-direction:column; gap:2px; min-width:0;}
  .mk-nav .hint{font-size:11px; color:var(--mk-muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .mk-nav .btns{display:flex; gap:8px; flex:0 0 auto;}
  .mk-nav a{display:inline-flex; align-items:center; justify-content:center; height:36px; padding:0 12px; border-radius:12px; border:1px solid var(--mk-line); text-decoration:none; font-weight:800; color:var(--mk-ink); background:#fff;}
  .mk-nav a.primary{border-color:transparent; background:linear-gradient(135deg, var(--mk-brand) 0%, #7aa5b4 100%); color:#fff;}

  @media (max-width: 480px) {
    .feature-home {
      grid-template-columns:1fr;
    }
  }
</style>
</head>
<body>

<div class="sys-toast" id="sysToast" role="status" aria-live="polite">å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ</div>

<div class="wrap">
  <header>
    <div class="brand">
      <a class="logo-link" href="https://takatrp.github.io/tool-portal/" target="_blank" rel="noopener">
        <img src="ãƒ­ã‚´.jpg" alt="æ¾æœ¬ä¼šè¨ˆäº‹å‹™æ‰€ãƒ­ã‚´" class="logo" onerror="this.style.display='none'" />
      </a>
      <h1 class="title">ã‚»ã‚­ãƒ¥ã‚¢PDFãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</h1>
    </div>
    <div class="subtitle">
      æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ã‚’å®ˆã‚‹ãŸã‚ã€ã‚µãƒ¼ãƒãƒ¼ã¸ã¯ä¸€åˆ‡é€ä¿¡ã›ãšã€ãŠä½¿ã„ã®ç«¯æœ«ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼‰ã ã‘ã§å®‰å…¨ã«PDFã‚’å‡¦ç†ã—ã¾ã™ã€‚
    </div>
  </header>
  <div id="action-status" class="action-status" aria-live="polite">æº–å‚™å®Œäº†</div>

  <div class="feature-back" id="feature-back">
    <button class="feature-back-btn" type="button" onclick="showFeatureHome()">â† æ©Ÿèƒ½ä¸€è¦§ã¸æˆ»ã‚‹</button>
  </div>

  <section class="card feature-panel active" id="feature-home">
    <div class="label big">ä½¿ã„ãŸã„æ©Ÿèƒ½ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
    <div class="feature-home">
      <button class="feature-link-btn" type="button" onclick="showFeaturePanel('merge')"><span class="feature-icon">ğŸ“‘</span><span class="feature-text">1. çµåˆ (Merge)</span></button>
      <button class="feature-link-btn" type="button" onclick="showFeaturePanel('extract')"><span class="feature-icon">âœ‚ï¸</span><span class="feature-text">2. åˆ†è§£ãƒ»æŠ½å‡º (Extract)</span></button>
      <button class="feature-link-btn" type="button" onclick="showFeaturePanel('insert')"><span class="feature-icon">â•</span><span class="feature-text">3. ãƒšãƒ¼ã‚¸è¿½åŠ  (Insert)</span></button>
      <button class="feature-link-btn" type="button" onclick="showFeaturePanel('delete')"><span class="feature-icon">ğŸ—‘ï¸</span><span class="feature-text">4. ãƒšãƒ¼ã‚¸å‰Šé™¤ (Delete)</span></button>
    </div>
  </section>

  <section class="card feature-panel" data-feature="merge">
    <div class="field">
      <div class="label big">ğŸ“‘ 1. çµåˆ (Merge)</div>
      <div class="helper">è¤‡æ•°ã®PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’1ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¾ã¨ã‚ã¾ã™ã€‚</div>
      <div class="file-box" id="merge-dropzone">
        <input type="file" id="merge-files" accept="application/pdf" multiple>
        <div class="drop-hint">ã“ã“ã«PDFã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦è¿½åŠ ã§ãã¾ã™ã€‚</div>
      </div>
      <div class="merge-empty" id="merge-empty">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’2ã¤ä»¥ä¸Šè¿½åŠ ã™ã‚‹ã¨çµåˆã§ãã¾ã™ã€‚</div>
      <div class="merge-list" id="merge-list" aria-live="polite"></div>
    </div>
    <button class="btn" onclick="handleMerge()">çµåˆã—ã¦ä¿å­˜</button>
  </section>

  <section class="card feature-panel" data-feature="extract">
    <div class="field">
      <div class="label big">âœ‚ï¸ 2. åˆ†è§£ãƒ»æŠ½å‡º (Extract)</div>
      <div class="helper">å…ƒã®PDFã‹ã‚‰ã€æŒ‡å®šã—ãŸãƒšãƒ¼ã‚¸ç¯„å›²ã¾ãŸã¯é¸æŠãƒšãƒ¼ã‚¸ã ã‘ã‚’åˆ‡ã‚Šå‡ºã—ã¾ã™ã€‚</div>
      <div class="file-box" id="extract-dropzone">
        <input type="file" id="extract-file" accept="application/pdf">
        <div class="drop-hint">ã“ã“ã«PDFã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦è¿½åŠ ã§ãã¾ã™ã€‚</div>
      </div>
      <div class="single-preview" id="extract-preview"></div>
    </div>
    <div class="field">
      <div class="flex-row">
        <input type="number" id="extract-start" class="input-num" min="1" value="1" placeholder="é–‹å§‹">
        <span>ã€œ</span>
        <input type="number" id="extract-end" class="input-num" min="1" value="1" placeholder="çµ‚äº†">
        <span>ãƒšãƒ¼ã‚¸</span>
      </div>
    </div>
    <button class="btn" onclick="handleExtract()">æŠ½å‡ºã—ã¦ä¿å­˜</button>
  </section>

  <section class="card feature-panel" data-feature="insert">
    <div class="field">
      <div class="label big">â• 3. ãƒšãƒ¼ã‚¸è¿½åŠ  (Insert)</div>
      <div class="helper">ãƒ™ãƒ¼ã‚¹ã¨ãªã‚‹PDFã®æŒ‡å®šã—ãŸä½ç½®ã«ã€åˆ¥ã®PDFã‚’æŒ¿å…¥ã—ã¾ã™ã€‚</div>
      <div class="file-box" id="insert-base-dropzone" style="margin-bottom:10px;">
        <div class="helper" style="margin:0 0 4px;">ãƒ™ãƒ¼ã‚¹ã®PDF</div>
        <input type="file" id="insert-base-file" accept="application/pdf">
        <div class="drop-hint">ã“ã“ã«PDFã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦è¿½åŠ ã§ãã¾ã™ã€‚</div>
      </div>
      <div class="single-preview" id="insert-base-preview" style="margin-bottom:10px;"></div>
      <div class="file-box" id="insert-add-dropzone">
        <div class="helper" style="margin:0 0 4px;">æŒ¿å…¥ã—ãŸã„PDF</div>
        <input type="file" id="insert-add-file" accept="application/pdf">
        <div class="drop-hint">ã“ã“ã«PDFã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦è¿½åŠ ã§ãã¾ã™ã€‚</div>
      </div>
      <div class="single-preview" id="insert-add-preview"></div>
    </div>
    <div class="field">
      <div class="flex-row">
        <span>æŒ¿å…¥ä½ç½®ï¼š</span>
        <input type="number" id="insert-position" class="input-num" min="1" value="2" style="max-width: 100px;">
        <span>ãƒšãƒ¼ã‚¸ç›®ã¨ã—ã¦</span>
      </div>
    </div>
    <button class="btn" onclick="handleInsert()">è¿½åŠ ã—ã¦ä¿å­˜</button>
  </section>

  <section class="card feature-panel" data-feature="delete">
    <div class="field">
      <div class="label big">ğŸ—‘ï¸ 4. ãƒšãƒ¼ã‚¸å‰Šé™¤ (Delete)</div>
      <div class="helper">æŒ‡å®šã—ãŸä¸è¦ãƒšãƒ¼ã‚¸ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰ã‚’å–ã‚Šé™¤ãã¾ã™ã€‚</div>
      <div class="file-box" id="delete-dropzone">
        <input type="file" id="delete-file" accept="application/pdf">
        <div class="drop-hint">ã“ã“ã«PDFã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦è¿½åŠ ã§ãã¾ã™ã€‚</div>
      </div>
      <div class="single-preview" id="delete-preview"></div>
    </div>
    <div class="field">
      <div class="flex-row">
        <span>å‰Šé™¤ã™ã‚‹ãƒšãƒ¼ã‚¸ï¼š</span>
        <input type="number" id="delete-page" class="input-num" min="1" value="1" style="max-width: 100px;">
      </div>
    </div>
    <button class="btn" onclick="handleDelete()">å‰Šé™¤ã—ã¦ä¿å­˜</button>
  </section>

  <footer class="mk-mini">
    Â© <span id="cpy-year">2025</span>
    <a href="https://www.matsumoto-kaikei.or.jp/" target="_blank" rel="noopener license">ç¨ç†å£«æ³•äººæ¾æœ¬ä¼šè¨ˆäº‹å‹™æ‰€</a>
    ï½œ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="license noopener">CC BY-NC-SA 4.0</a>
    ï½œ <a href="/tool-portal/terms.html" target="_blank" rel="noopener">åˆ©ç”¨æ¡ä»¶</a>
    ï½œ <span id="build-rev">r15</span>ï¼ˆ<span id="last-updated-date"></span>ï¼‰
  </footer>
</div>

<div class="mk-nav" id="mk-nav">
  <div class="inner">
    <div class="left">
      <div style="font-weight:900;">æ¾æœ¬ä¼šè¨ˆãƒ„ãƒ¼ãƒ«</div>
      <div class="hint">ãƒãƒ¼ã‚¿ãƒ«ã¸æˆ»ã‚‹</div>
    </div>
    <div class="btns">
      <a href="https://takatrp.github.io/tool-portal/" id="mk-back">â† ãƒãƒ¼ã‚¿ãƒ«</a>
    </div>
  </div>
</div>

<div class="thumb-modal" id="thumb-modal" role="dialog" aria-label="PDFã‚µãƒ ãƒã‚¤ãƒ«æ‹¡å¤§è¡¨ç¤º">
  <div class="thumb-modal-card">
    <canvas id="thumb-modal-canvas"></canvas>
    <div class="single-note" style="margin-top:8px;">ã‚¿ãƒƒãƒ—ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã¾ã™ã€‚æ‹¡å¤§è¡¨ç¤ºã¯é«˜è§£åƒåº¦ã§æç”»ã•ã‚Œã¾ã™ã€‚</div>
  </div>
</div>

<script>
  // å¹´åº¦ãƒ»revãƒ»æœ€çµ‚æ›´æ–°æ—¥ã‚’è‡ªå‹•æ›´æ–°
  const VERSION = 'r15';
  document.getElementById('cpy-year').textContent = new Date().getFullYear();
  const d = new Date(document.lastModified);
  const yyyy = String(d.getFullYear());
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const dd = String(d.getDate()).padStart(2, '0');
  document.getElementById('last-updated-date').textContent = `${yyyy}-${mm}-${dd}`;
  document.getElementById('build-rev').textContent = VERSION;

  const { PDFDocument } = PDFLib;
  const mergeFilesState = [];
  const mergeInput = document.getElementById('merge-files');
  const mergeDropzone = document.getElementById('merge-dropzone');
  const mergeListEl = document.getElementById('merge-list');
  const mergeEmptyEl = document.getElementById('merge-empty');
  const sysToastEl = document.getElementById('sysToast');
  const thumbModalEl = document.getElementById('thumb-modal');
  const thumbModalCanvas = document.getElementById('thumb-modal-canvas');
  const actionStatusEl = document.getElementById('action-status');
  const featureBackEl = document.getElementById('feature-back');
  const featureHomeEl = document.getElementById('feature-home');
  const featurePanels = Array.from(document.querySelectorAll('.feature-panel[data-feature]'));
  const singleFileState = {
    'extract-file': null,
    'insert-base-file': null,
    'insert-add-file': null,
    'delete-file': null,
  };
  const selectedPagesState = {
    extract: new Set(),
    delete: new Set(),
  };

  function showFeaturePanel(featureName) {
    featureHomeEl.classList.remove('active');
    featurePanels.forEach((panel) => panel.classList.toggle('active', panel.dataset.feature === featureName));
    featureBackEl.classList.add('show');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function showFeatureHome() {
    featurePanels.forEach((panel) => panel.classList.remove('active'));
    featureHomeEl.classList.add('active');
    featureBackEl.classList.remove('show');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  let pdfjsLibPromise;

  async function getPdfJsLib() {
    if (!pdfjsLibPromise) {
      pdfjsLibPromise = import('https://unpkg.com/pdfjs-dist@4.5.136/build/pdf.min.mjs').then((pdfjsLib) => {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@4.5.136/build/pdf.worker.min.mjs';
        return pdfjsLib;
      });
    }
    return pdfjsLibPromise;
  }

  // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
  function showToast(msg, isError = false) {
    sysToastEl.textContent = msg;
    sysToastEl.style.color = isError ? '#e74c3c' : '#1e2a2d';
    sysToastEl.style.borderColor = isError ? '#e74c3c' : 'rgba(87,136,153,.35)';
    actionStatusEl.textContent = msg;
    actionStatusEl.classList.toggle('error', isError);
    sysToastEl.classList.add('show');
    clearTimeout(showToast._timer);
    showToast._timer = setTimeout(() => {
      sysToastEl.classList.remove('show');
    }, 3000);
  }

  async function readFileAsArrayBuffer(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsArrayBuffer(file);
    });
  }

  function downloadPDF(pdfBytes, filename) {
    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
    showToast('å‡¦ç†ãŒå®Œäº†ã—ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚');
  }

  function setSingleFileToInput(inputEl, file) {
    try {
      const dt = new DataTransfer();
      dt.items.add(file);
      inputEl.files = dt.files;
    } catch (_) {
      // Safari ãªã© DataTransfer ã®ç›´æ¥ç”Ÿæˆã«æœªå¯¾å¿œã®ç’°å¢ƒã§ã¯çŠ¶æ…‹ç®¡ç†ã®ã¿ã§å‡¦ç†ã™ã‚‹
    }
  }

  function getSelectedSingleFile(inputId) {
    return singleFileState[inputId] || document.getElementById(inputId).files[0] || null;
  }


  function getSelectedPages(selectionKey) {
    if (!selectionKey || !selectedPagesState[selectionKey]) return [];
    return Array.from(selectedPagesState[selectionKey]).sort((a, b) => a - b);
  }

  function toggleSelectedPage(selectionKey, pageNum) {
    if (!selectionKey || !selectedPagesState[selectionKey]) return;
    const set = selectedPagesState[selectionKey];
    if (set.has(pageNum)) set.delete(pageNum);
    else set.add(pageNum);
  }

  function bindDropzoneFileInput({ inputId, dropzoneId, previewId, noteText, showAllPages = false, selectionKey = null }) {
    const inputEl = document.getElementById(inputId);
    const dropzoneEl = document.getElementById(dropzoneId);
    const previewEl = document.getElementById(previewId);
    if (!inputEl || !dropzoneEl || !previewEl) return;

    const renderSinglePreview = async () => {
      const updateSelectionNote = () => {
        if (!selectionKey || !selectedPagesState[selectionKey]) return noteText;
        const selectedCount = selectedPagesState[selectionKey].size;
        return selectedCount ? `${noteText}ï¼ˆé¸æŠä¸­: ${selectedCount}ãƒšãƒ¼ã‚¸ / æ‹¡å¤§ã¯[æ‹¡å¤§]ï¼‰` : `${noteText}ï¼ˆã‚¿ãƒƒãƒ—ã§é¸æŠãƒ»[æ‹¡å¤§]ã§è¡¨ç¤ºï¼‰`;
      };

      const file = getSelectedSingleFile(inputId);
      if (!file) {
        previewEl.classList.remove('show', 'multi-pages');
        previewEl.innerHTML = '';
        if (selectionKey && selectedPagesState[selectionKey]) selectedPagesState[selectionKey].clear();
        return;
      }
      previewEl.classList.add('show');
      previewEl.classList.toggle('multi-pages', showAllPages);
      previewEl.innerHTML = '';

      const thumbWrap = document.createElement('div');
      thumbWrap.className = 'thumb-wrap zoomable';
      const canvas = document.createElement('canvas');
      thumbWrap.appendChild(canvas);
      thumbWrap.addEventListener('click', async () => {
        await renderPdfThumbnail(file, thumbModalCanvas, { targetWidth: 1200, targetHeight: 1600 });
        thumbModalEl.classList.add('show');
      });

      const meta = document.createElement('div');
      meta.className = 'single-meta';
      const name = document.createElement('p');
      name.className = 'single-name';
      name.textContent = file.name;
      name.title = file.name;
      const note = document.createElement('p');
      note.className = 'single-note';
      note.textContent = updateSelectionNote();
      meta.append(name, note);

      if (!showAllPages) {
        previewEl.append(thumbWrap, meta);
        await renderPdfThumbnail(file, canvas);
        return;
      }

      const header = document.createElement('div');
      header.className = 'single-preview-header';
      header.append(thumbWrap, meta);
      previewEl.appendChild(header);
      await renderPdfThumbnail(file, canvas);

      const pagesGrid = document.createElement('div');
      pagesGrid.className = 'single-pages-grid';
      previewEl.appendChild(pagesGrid);
      await renderAllPdfPages(file, pagesGrid, { selectionKey, onSelectionChange: () => { note.textContent = updateSelectionNote(); } });
    };

    inputEl.addEventListener('change', () => {
      singleFileState[inputId] = inputEl.files[0] || null;
      if (selectionKey && selectedPagesState[selectionKey]) selectedPagesState[selectionKey].clear();
      renderSinglePreview();
    });
    ['dragenter', 'dragover'].forEach((eventName) => {
      dropzoneEl.addEventListener(eventName, (e) => {
        e.preventDefault();
        dropzoneEl.classList.add('dragover');
      });
    });
    ['dragleave', 'drop'].forEach((eventName) => {
      dropzoneEl.addEventListener(eventName, (e) => {
        e.preventDefault();
        dropzoneEl.classList.remove('dragover');
      });
    });
    dropzoneEl.addEventListener('drop', (e) => {
      const files = Array.from(e.dataTransfer.files).filter((file) => file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf'));
      if (!files.length) return;
      singleFileState[inputId] = files[0];
      if (selectionKey && selectedPagesState[selectionKey]) selectedPagesState[selectionKey].clear();
      setSingleFileToInput(inputEl, files[0]);
      renderSinglePreview();
    });
  }

  async function renderPdfThumbnail(file, canvas, options = {}) {
    const targetWidth = options.targetWidth || 88;
    const targetHeight = options.targetHeight || 120;

    const drawFallback = () => {
      const ctx = canvas.getContext('2d');
      canvas.width = targetWidth;
      canvas.height = targetHeight;
      ctx.fillStyle = '#eff5f7';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#577783';
      ctx.font = 'bold 11px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('PDF', canvas.width / 2, canvas.height / 2 + 4);
    };

    // å…ˆã«ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’æç”»ã—ã¦ã€èª­ã¿è¾¼ã¿å¤±æ•—æ™‚ã§ã‚‚ã‚µãƒ ãƒã‚¤ãƒ«é ˜åŸŸãŒç©ºã«ãªã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹
    drawFallback();

    try {
      const pdfjsLib = await getPdfJsLib();
      const arrayBuffer = await readFileAsArrayBuffer(file);
      const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
      const pdf = await loadingTask.promise;
      const page = await pdf.getPage(1);
      const viewport = page.getViewport({ scale: 1 });
      const scale = Math.min(targetWidth / viewport.width, targetHeight / viewport.height);
      const scaledViewport = page.getViewport({ scale });
      canvas.width = scaledViewport.width;
      canvas.height = scaledViewport.height;
      const ctx = canvas.getContext('2d');
      await page.render({ canvasContext: ctx, viewport: scaledViewport }).promise;
    } catch (err) {
      drawFallback();
    }
  }


  async function renderAllPdfPages(file, container, options = {}) {
    const selectionKey = options.selectionKey || null;
    const onSelectionChange = options.onSelectionChange || (() => {});
    container.innerHTML = '';
    try {
      const pdfjsLib = await getPdfJsLib();
      const arrayBuffer = await readFileAsArrayBuffer(file);
      const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
      const pdf = await loadingTask.promise;

      for (let pageNum = 1; pageNum <= pdf.numPages; pageNum += 1) {
        const pageItem = document.createElement('div');
        pageItem.className = 'single-page-item';

        const pageThumb = document.createElement('div');
        pageThumb.className = 'thumb-wrap zoomable';
        const pageCanvas = document.createElement('canvas');
        pageThumb.appendChild(pageCanvas);
        if (!selectionKey) {
          pageThumb.addEventListener('click', async () => {
            await renderPdfPageToCanvas(pdf, pageNum, thumbModalCanvas, { targetWidth: 1200, targetHeight: 1600 });
            thumbModalEl.classList.add('show');
          });
        }

        const pageLabel = document.createElement('p');
        pageLabel.className = 'single-page-number';
        pageLabel.textContent = `${pageNum}ãƒšãƒ¼ã‚¸ç›®`;

        const actions = document.createElement('div');
        actions.className = 'single-page-actions';

        const zoomBtn = document.createElement('button');
        zoomBtn.className = 'single-page-btn';
        zoomBtn.type = 'button';
        zoomBtn.textContent = 'æ‹¡å¤§';
        zoomBtn.addEventListener('click', async (e) => {
          e.stopPropagation();
          await renderPdfPageToCanvas(pdf, pageNum, thumbModalCanvas, { targetWidth: 1200, targetHeight: 1600 });
          thumbModalEl.classList.add('show');
        });

        actions.appendChild(zoomBtn);

        if (selectionKey) {
          const selectBtn = document.createElement('button');
          selectBtn.className = 'single-page-btn';
          selectBtn.type = 'button';
          const syncSelectBtn = () => {
            const selected = selectedPagesState[selectionKey].has(pageNum);
            selectBtn.textContent = selected ? 'é¸æŠè§£é™¤' : 'é¸æŠ';
          };
          selectBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleSelectedPage(selectionKey, pageNum);
            pageItem.classList.toggle('selected', selectedPagesState[selectionKey].has(pageNum));
            syncSelectBtn();
            onSelectionChange();
          });
          actions.appendChild(selectBtn);
          if (selectedPagesState[selectionKey]?.has(pageNum)) {
            pageItem.classList.add('selected');
          }
          syncSelectBtn();
        }

        pageThumb.addEventListener('contextmenu', (e) => e.preventDefault());
        pageItem.addEventListener('dblclick', (e) => e.preventDefault());
        pageItem.addEventListener('click', () => {
          if (!selectionKey) return;
          toggleSelectedPage(selectionKey, pageNum);
          pageItem.classList.toggle('selected', selectedPagesState[selectionKey].has(pageNum));
          const maybeBtn = actions.querySelector('.single-page-btn:last-child');
          if (maybeBtn && maybeBtn.textContent !== 'æ‹¡å¤§') {
            maybeBtn.textContent = selectedPagesState[selectionKey].has(pageNum) ? 'é¸æŠè§£é™¤' : 'é¸æŠ';
          }
          onSelectionChange();
        });

        pageItem.append(pageThumb, pageLabel, actions);
        container.appendChild(pageItem);
        await renderPdfPageToCanvas(pdf, pageNum, pageCanvas);
      }
    } catch (error) {
      container.innerHTML = '';
      const note = document.createElement('p');
      note.className = 'single-note';
      note.textContent = 'ãƒšãƒ¼ã‚¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
      container.appendChild(note);
    }
  }

  async function renderPdfPageToCanvas(pdf, pageNum, canvas, options = {}) {
    const targetWidth = options.targetWidth || 88;
    const targetHeight = options.targetHeight || 120;
    const page = await pdf.getPage(pageNum);
    const viewport = page.getViewport({ scale: 1 });
    const scale = Math.min(targetWidth / viewport.width, targetHeight / viewport.height);
    const scaledViewport = page.getViewport({ scale });
    canvas.width = scaledViewport.width;
    canvas.height = scaledViewport.height;
    const ctx = canvas.getContext('2d');
    await page.render({ canvasContext: ctx, viewport: scaledViewport }).promise;
  }

  function syncMergeVisibility() {
    mergeEmptyEl.style.display = mergeFilesState.length ? 'none' : 'block';
  }

  function renderMergeList() {
    mergeListEl.innerHTML = '';
    mergeFilesState.forEach((item, index) => {
      const row = document.createElement('div');
      row.className = 'merge-item';

      const thumbWrap = document.createElement('div');
      thumbWrap.className = 'thumb-wrap';
      const canvas = document.createElement('canvas');
      thumbWrap.appendChild(canvas);
      thumbWrap.classList.add('zoomable');
      thumbWrap.addEventListener('click', async () => {
        await renderPdfThumbnail(item.file, thumbModalCanvas, { targetWidth: 1200, targetHeight: 1600 });
        thumbModalEl.classList.add('show');
      });

      const meta = document.createElement('div');
      meta.className = 'merge-meta';
      const name = document.createElement('p');
      name.className = 'merge-name';
      name.textContent = item.file.name;
      name.title = item.file.name;
      const orderBadge = document.createElement('p');
      orderBadge.className = 'merge-order-badge';
      orderBadge.textContent = `${index + 1}ç•ªç›®`;

      meta.append(name);

      const actions = document.createElement('div');
      actions.className = 'merge-actions';

      const toggleBtn = document.createElement('button');
      toggleBtn.className = 'mini-btn';
      toggleBtn.textContent = item.expanded ? 'æŠ˜ã‚ŠãŸãŸã‚€' : 'å…¨éƒ¨è¡¨ç¤º';
      toggleBtn.type = 'button';
      toggleBtn.addEventListener('click', () => {
        item.expanded = !item.expanded;
        renderMergeList();
      });

      const removeBtn = document.createElement('button');
      removeBtn.className = 'mini-btn';
      removeBtn.textContent = 'å‰Šé™¤';
      removeBtn.type = 'button';
      removeBtn.addEventListener('click', () => {
        mergeFilesState.splice(index, 1);
        renderMergeList();
      });

      const moveWrap = document.createElement('div');
      moveWrap.className = 'merge-move';

      const moveUpBtn = document.createElement('button');
      moveUpBtn.className = 'mini-btn move-btn';
      moveUpBtn.textContent = 'â–²';
      moveUpBtn.type = 'button';
      moveUpBtn.title = 'ä¸Šã«ç§»å‹•';
      moveUpBtn.disabled = index === 0;
      moveUpBtn.addEventListener('click', () => moveMergeItem(index, -1));

      const moveDownBtn = document.createElement('button');
      moveDownBtn.className = 'mini-btn move-btn';
      moveDownBtn.textContent = 'â–¼';
      moveDownBtn.type = 'button';
      moveDownBtn.title = 'ä¸‹ã«ç§»å‹•';
      moveDownBtn.disabled = index === mergeFilesState.length - 1;
      moveDownBtn.addEventListener('click', () => moveMergeItem(index, 1));

      moveWrap.append(moveUpBtn, moveDownBtn);

      if (item.expanded) {
        name.classList.add('expanded');
        const fullName = document.createElement('p');
        fullName.className = 'merge-fullname';
        fullName.textContent = item.file.name;
        meta.appendChild(fullName);
      }

      actions.append(toggleBtn, removeBtn, moveWrap);
      row.append(orderBadge, thumbWrap, meta, actions);
      mergeListEl.appendChild(row);
      renderPdfThumbnail(item.file, canvas);
    });

    syncMergeVisibility();
  }

  function addFilesToMergeState(fileList) {
    const files = Array.from(fileList).filter((file) => file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf'));
    files.forEach((file) => {
      mergeFilesState.push({ file, expanded: false });
    });
    renderMergeList();
  }

  mergeInput.addEventListener('change', (e) => {
    addFilesToMergeState(e.target.files);
    mergeInput.value = '';
  });

  ['dragenter', 'dragover'].forEach((eventName) => {
    mergeDropzone.addEventListener(eventName, (e) => {
      e.preventDefault();
      mergeDropzone.classList.add('dragover');
    });
  });
  ['dragleave', 'drop'].forEach((eventName) => {
    mergeDropzone.addEventListener(eventName, (e) => {
      e.preventDefault();
      mergeDropzone.classList.remove('dragover');
    });
  });
  mergeDropzone.addEventListener('drop', (e) => {
    addFilesToMergeState(e.dataTransfer.files);
  });

  function moveMergeItem(index, direction) {
    const targetIndex = index + direction;
    if (targetIndex < 0 || targetIndex >= mergeFilesState.length) return;
    const [moved] = mergeFilesState.splice(index, 1);
    mergeFilesState.splice(targetIndex, 0, moved);
    renderMergeList();
  }

  thumbModalEl.addEventListener('click', () => {
    thumbModalEl.classList.remove('show');
  });

  window.addEventListener('error', (event) => {
    const rawMessage = event?.message || '';
    const message = String(rawMessage).trim();
    if (!message || message === 'Script error.' || message === 'Script error') return;
    showToast(`ã‚¨ãƒ©ãƒ¼: ${message}`, true);
  });

  window.addEventListener('unhandledrejection', (event) => {
    showToast(`ã‚¨ãƒ©ãƒ¼: ${event.reason?.message || 'å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'}`, true);
  });

  bindDropzoneFileInput({ inputId: 'extract-file', dropzoneId: 'extract-dropzone', previewId: 'extract-preview', noteText: 'æŠ½å‡ºå¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«', showAllPages: true, selectionKey: 'extract' });
  bindDropzoneFileInput({ inputId: 'insert-base-file', dropzoneId: 'insert-base-dropzone', previewId: 'insert-base-preview', noteText: 'æŒ¿å…¥å…ˆï¼ˆãƒ™ãƒ¼ã‚¹ï¼‰ãƒ•ã‚¡ã‚¤ãƒ«', showAllPages: true });
  bindDropzoneFileInput({ inputId: 'insert-add-file', dropzoneId: 'insert-add-dropzone', previewId: 'insert-add-preview', noteText: 'æŒ¿å…¥å…ƒãƒ•ã‚¡ã‚¤ãƒ«', showAllPages: true });
  bindDropzoneFileInput({ inputId: 'delete-file', dropzoneId: 'delete-dropzone', previewId: 'delete-preview', noteText: 'å‰Šé™¤å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«', showAllPages: true, selectionKey: 'delete' });

  // --- 1. çµåˆ ---
  async function handleMerge() {
    if (mergeFilesState.length < 2) return showToast('2ã¤ä»¥ä¸Šã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', true);
    
    showToast('å‡¦ç†ä¸­...');
    try {
      const mergedPdf = await PDFDocument.create();
      for (let { file } of mergeFilesState) {
        const bytes = await readFileAsArrayBuffer(file);
        const pdf = await PDFDocument.load(bytes);
        const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
        copiedPages.forEach((page) => mergedPdf.addPage(page));
      }
      const pdfBytes = await mergedPdf.save();
      downloadPDF(pdfBytes, 'merged_document.pdf');
    } catch (e) {
      showToast('ã‚¨ãƒ©ãƒ¼: ä¿è­·ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒå«ã¾ã‚Œã¦ã„ãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚', true);
    }
  }

  // --- 2. æŠ½å‡º ---
  async function handleExtract() {
    const file = getSelectedSingleFile('extract-file');
    const start = parseInt(document.getElementById('extract-start').value);
    const end = parseInt(document.getElementById('extract-end').value);
    const selectedPages = getSelectedPages('extract');
    
    if (!file) return showToast('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', true);
    if (!selectedPages.length && (start > end || start < 1)) return showToast('æ­£ã—ã„ãƒšãƒ¼ã‚¸ç¯„å›²ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚', true);

    showToast('å‡¦ç†ä¸­...');
    try {
      const bytes = await readFileAsArrayBuffer(file);
      const sourcePdf = await PDFDocument.load(bytes);
      const totalPages = sourcePdf.getPageCount();

      if (selectedPages.length && selectedPages.some((page) => page > totalPages)) return showToast(`ã“ã®PDFã¯${totalPages}ãƒšãƒ¼ã‚¸ã¾ã§ã§ã™ã€‚`, true);
      if (!selectedPages.length && end > totalPages) return showToast(`ã“ã®PDFã¯${totalPages}ãƒšãƒ¼ã‚¸ã¾ã§ã§ã™ã€‚`, true);

      const newPdf = await PDFDocument.create();
      const indices = selectedPages.length
        ? selectedPages.map((page) => page - 1)
        : Array.from({ length: end - start + 1 }, (_, i) => (start - 1) + i);
      const copiedPages = await newPdf.copyPages(sourcePdf, indices);
      copiedPages.forEach((page) => newPdf.addPage(page));

      const pdfBytes = await newPdf.save();
      const extractSuffix = selectedPages.length ? `selected_${selectedPages.join('-')}` : `${start}-${end}`;
      downloadPDF(pdfBytes, `extracted_${extractSuffix}.pdf`);
    } catch (e) {
      showToast('ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¿è­·ã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚', true);
    }
  }

  // --- 3. è¿½åŠ  ---
  async function handleInsert() {
    const baseFile = getSelectedSingleFile('insert-base-file');
    const addFile = getSelectedSingleFile('insert-add-file');
    const position = parseInt(document.getElementById('insert-position').value);

    if (!baseFile || !addFile) return showToast('2ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', true);
    if (position < 1) return showToast('æ­£ã—ã„ãƒšãƒ¼ã‚¸ä½ç½®ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚', true);

    showToast('å‡¦ç†ä¸­...');
    try {
      const baseBytes = await readFileAsArrayBuffer(baseFile);
      const addBytes = await readFileAsArrayBuffer(addFile);
      const basePdf = await PDFDocument.load(baseBytes);
      const addPdf = await PDFDocument.load(addBytes);
      
      const totalPages = basePdf.getPageCount();
      let insertIndex = position - 1;
      if (insertIndex > totalPages) insertIndex = totalPages;

      const copiedPages = await basePdf.copyPages(addPdf, addPdf.getPageIndices());
      copiedPages.forEach((page, index) => {
        basePdf.insertPage(insertIndex + index, page);
      });

      const pdfBytes = await basePdf.save();
      downloadPDF(pdfBytes, 'inserted_document.pdf');
    } catch (e) {
      showToast('ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¿è­·ã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚', true);
    }
  }

  // --- 4. å‰Šé™¤ ---
  async function handleDelete() {
    const file = getSelectedSingleFile('delete-file');
    const pageNum = parseInt(document.getElementById('delete-page').value);
    const selectedPages = getSelectedPages('delete');

    if (!file) return showToast('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', true);
    if (!selectedPages.length && pageNum < 1) return showToast('æ­£ã—ã„ãƒšãƒ¼ã‚¸ç•ªå·ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚', true);

    showToast('å‡¦ç†ä¸­...');
    try {
      const bytes = await readFileAsArrayBuffer(file);
      const pdf = await PDFDocument.load(bytes);
      const totalPages = pdf.getPageCount();
      
      if (selectedPages.length && selectedPages.some((page) => page > totalPages)) return showToast(`ã“ã®PDFã¯${totalPages}ãƒšãƒ¼ã‚¸ã¾ã§ã§ã™ã€‚`, true);
      if (!selectedPages.length && pageNum > totalPages) return showToast(`ã“ã®PDFã¯${totalPages}ãƒšãƒ¼ã‚¸ã¾ã§ã§ã™ã€‚`, true);

      const deleteTargets = selectedPages.length ? selectedPages : [pageNum];
      deleteTargets.sort((a, b) => b - a).forEach((page) => pdf.removePage(page - 1));
      const pdfBytes = await pdf.save();
      downloadPDF(pdfBytes, 'deleted_document.pdf');
    } catch (e) {
      showToast('ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¿è­·ã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚', true);
    }
  }
</script>
</body>
</html>
